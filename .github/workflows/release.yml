name: Create Release with Mobile Builds

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  FLUTTER_VERSION: '3.27.1'

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Alarm Messenger Release ${{ steps.get_version.outputs.version }}
            
            ### üì¶ Inhalte
            
            **Server:**
            - Docker Image: `ghcr.io/timux/alarm-messenger:${{ steps.get_version.outputs.version }}`
            - Docker Image wird automatisch gebaut und zu GitHub Container Registry gepusht
            
            **Mobile App:**
            - ‚úÖ Android APK (Debug & Release)
            - ‚úÖ Android App Bundle (AAB) f√ºr Google Play
            - ‚úÖ iOS Build (ohne Code-Signatur)
            
            ### üöÄ Deployment
            
            **Server mit Docker:**
            ```bash
            docker pull ghcr.io/timux/alarm-messenger:${{ steps.get_version.outputs.version }}
            ```
            
            **Mobile App:**
            - **Android APK**: Download `app-release.apk` von den Assets unten
            - **Google Play**: Upload `app-release.aab` zur Google Play Console
            - **iOS**: Ben√∂tigt Xcode und Code-Signatur f√ºr Deployment
            
            ### üìù √Ñnderungen
            
            <!-- Hier √Ñnderungen beschreiben -->
            
            ### üîó Links
            
            - [Dokumentation](https://github.com/TimUx/alarm-messenger#readme)
            - [Docker-Quickstart](https://github.com/TimUx/alarm-messenger/blob/main/DOCKER-QUICKSTART.md)
            - [Mobile App Setup](https://github.com/TimUx/alarm-messenger/blob/main/mobile/README.md)
          draft: false
          prerelease: false

  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Flutter Doctor
        working-directory: mobile
        run: flutter doctor -v
      
      - name: Get dependencies
        working-directory: mobile
        run: flutter pub get
      
      - name: Analyze code
        working-directory: mobile
        run: flutter analyze
      
      - name: Run tests
        working-directory: mobile
        run: |
          if [ -d "test" ]; then
            echo "Running tests..."
            flutter test
          else
            echo "No test directory found. Skipping tests."
          fi
      
      - name: Build Android Debug APK
        working-directory: mobile
        run: flutter build apk --debug
      
      - name: Decode Keystore (Release)
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > mobile/android/app/alarm-messenger.keystore
            echo "‚úÖ Keystore decoded successfully"
          else
            echo "‚ö†Ô∏è  Warning: ANDROID_KEYSTORE_BASE64 secret not set. Release build will be skipped."
            echo "‚ö†Ô∏è  To enable release builds, configure Android signing secrets in GitHub repository settings."
          fi
      
      - name: Build Android Release APK
        working-directory: mobile
        env:
          MYAPP_RELEASE_STORE_FILE: alarm-messenger.keystore
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -f android/app/alarm-messenger.keystore ]; then
            echo "Building release APK..."
            flutter build apk --release
            echo "‚úÖ Release APK built successfully"
          else
            echo "‚ö†Ô∏è  Keystore not found. Creating unsigned release APK..."
            flutter build apk --release
          fi
      
      - name: Build Android App Bundle (AAB)
        working-directory: mobile
        env:
          MYAPP_RELEASE_STORE_FILE: alarm-messenger.keystore
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -f android/app/alarm-messenger.keystore ]; then
            echo "Building release AAB..."
            flutter build appbundle --release
            echo "‚úÖ Release AAB built successfully"
          else
            echo "‚ö†Ô∏è  Keystore not found. Skipping AAB build."
          fi
      
      - name: Upload Debug APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: mobile/build/app/outputs/flutter-apk/app-debug.apk
          asset_name: alarm-messenger-${{ needs.create-release.outputs.version }}-debug.apk
          asset_content_type: application/vnd.android.package-archive
      
      - name: Upload Release APK to Release
        if: hashFiles('mobile/build/app/outputs/flutter-apk/app-release.apk') != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: mobile/build/app/outputs/flutter-apk/app-release.apk
          asset_name: alarm-messenger-${{ needs.create-release.outputs.version }}-release.apk
          asset_content_type: application/vnd.android.package-archive
      
      - name: Upload Release AAB to Release
        if: hashFiles('mobile/build/app/outputs/bundle/release/app-release.aab') != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: mobile/build/app/outputs/bundle/release/app-release.aab
          asset_name: alarm-messenger-${{ needs.create-release.outputs.version }}-release.aab
          asset_content_type: application/octet-stream

  build-ios:
    name: Build iOS App
    runs-on: macos-14
    needs: create-release
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Flutter Doctor
        working-directory: mobile
        run: flutter doctor -v
      
      - name: Get dependencies
        working-directory: mobile
        run: flutter pub get
      
      - name: Check and regenerate iOS platform
        working-directory: mobile
        run: |
          if [ ! -d "ios/Runner.xcodeproj" ]; then
            echo "‚ö†Ô∏è  iOS project files are missing. Regenerating iOS platform..."
            flutter create --org com.alarmmessenger --platforms=ios .
            echo "‚úÖ iOS platform files regenerated"
          else
            echo "‚úÖ iOS project files found"
          fi
      
      - name: Build iOS (no codesign)
        working-directory: mobile
        run: |
          echo "Building iOS app without code signing..."
          flutter build ios --release --no-codesign
          echo "‚úÖ iOS app built successfully"
      
      - name: Create iOS Archive Info
        working-directory: mobile
        run: |
          echo "# iOS Build Information" > ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "iOS app wurde erfolgreich gebaut (ohne Code-Signatur)." >> ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "## Deployment" >> ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "F√ºr iOS Distribution sind folgende Schritte erforderlich:" >> ios-build-info.txt
          echo "1. Apple Developer Account einrichten" >> ios-build-info.txt
          echo "2. Code-Signatur-Zertifikate konfigurieren" >> ios-build-info.txt
          echo "3. App in Xcode √∂ffnen und signieren" >> ios-build-info.txt
          echo "4. IPA-Datei f√ºr Distribution erstellen" >> ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "## Weitere Informationen" >> ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "Siehe: https://docs.flutter.dev/deployment/ios" >> ios-build-info.txt
          echo "" >> ios-build-info.txt
          echo "Build-Verzeichnis: mobile/build/ios/Release-iphoneos/Runner.app" >> ios-build-info.txt
      
      - name: Upload iOS Build Info to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: mobile/ios-build-info.txt
          asset_name: ios-build-info.txt
          asset_content_type: text/plain

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [create-release, build-android, build-ios]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Build Summary
        run: |
          echo "## üì¶ Release ${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Release erstellt: ‚úÖ ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Android Build: ‚úÖ ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS Build: ‚úÖ ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Mobile App Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Android Debug APK: ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- Android Release APK: ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- Android App Bundle (AAB): ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- iOS Build Info: ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üê≥ Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "Der Docker-Build wird automatisch durch den 'build-and-push' Workflow gestartet." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`ghcr.io/timux/alarm-messenger:${{ needs.create-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Release" >> $GITHUB_STEP_SUMMARY
          echo "GitHub Release: [Release ${{ needs.create-release.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
