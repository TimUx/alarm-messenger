name: Mobile App Build

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-build.yml'
  pull_request:
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-build.yml'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  android:
    name: Build Android APK
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
      actions: read    # Required for accessing artifacts
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Install dependencies
        working-directory: mobile
        run: npm ci
      
      - name: Make gradlew executable
        working-directory: mobile/android
        run: chmod +x gradlew
      
      - name: Android diagnostics - list files
        working-directory: mobile/android
        run: |
          echo "== mobile/android =="
          ls -la
          echo "Gradle wrapper:"
          ls -la gradlew || true
      
      - name: Android diagnostics - Java & Gradle
        working-directory: mobile/android
        run: |
          java -version || true
          echo "JAVA_HOME=$JAVA_HOME"
          ./gradlew --version || true
      
      - name: Build Debug APK
        working-directory: mobile/android
        run: ./gradlew clean assembleDebug --stacktrace --info --no-daemon
      
      - name: Print build.gradle heads on failure
        if: failure()
        working-directory: mobile/android
        run: |
          echo "----- android/build.gradle -----"
          head -n 200 build.gradle || true
          echo "----- android/app/build.gradle -----"
          head -n 200 app/build.gradle || true
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: mobile/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
      
      # Release build only for tags or workflow_dispatch
      - name: Decode Keystore (Release)
        if: startsWith(github.ref, 'refs/tags/mobile-v') || github.event_name == 'workflow_dispatch'
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > mobile/android/app/alarm-messenger.keystore
            echo "Keystore decoded successfully"
          else
            echo "Warning: ANDROID_KEYSTORE_BASE64 secret not set. Skipping release build."
            exit 0
          fi
      
      - name: Build Release APK
        if: startsWith(github.ref, 'refs/tags/mobile-v') || github.event_name == 'workflow_dispatch'
        working-directory: mobile/android
        env:
          MYAPP_RELEASE_STORE_FILE: alarm-messenger.keystore
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -f app/alarm-messenger.keystore ]; then
            ./gradlew assembleRelease --no-daemon
          else
            echo "Keystore not found. Skipping release build."
          fi
      
      - name: Upload Release APK
        if: startsWith(github.ref, 'refs/tags/mobile-v') || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: mobile/android/app/build/outputs/apk/release/app-release.apk
          retention-days: 90
      
      - name: Build Release AAB (Play Store)
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        working-directory: mobile/android
        env:
          MYAPP_RELEASE_STORE_FILE: alarm-messenger.keystore
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -f app/alarm-messenger.keystore ]; then
            ./gradlew bundleRelease --no-daemon
          fi
      
      - name: Upload Release AAB
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        uses: actions/upload-artifact@v4
        with:
          name: app-release-bundle
          path: mobile/android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 90
      
      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mobile/android/app/build/outputs/apk/release/app-release.apk
            mobile/android/app/build/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios:
    name: Build iOS IPA
    runs-on: macos-14
    permissions:
      contents: read  # Required for checking out code
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        working-directory: mobile
        run: npm ci
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false
      
      - name: iOS diagnostics - ruby & files
        working-directory: mobile/ios
        run: |
          ruby --version || true
          echo "Gem list (cocoapods):"; gem list --local | grep cocoapods || true
          ls -la
          ls -la AlarmMessenger.xcworkspace AlarmMessenger.xcodeproj || true
      
      - name: Install CocoaPods and Bundler
        working-directory: mobile/ios
        run: |
          if [ -f Gemfile ]; then
            gem install bundler && bundle install
            bundle exec pod install --repo-update
          else
            gem install cocoapods
            pod install --repo-update
          fi
      
      - name: iOS diagnostics - pod & xcode
        working-directory: mobile/ios
        run: |
          pod --version || true
          xcodebuild -list -workspace AlarmMessenger.xcworkspace -scheme AlarmMessenger || true
      
      - name: Build iOS App (Debug)
        working-directory: mobile/ios
        run: |
          set -o pipefail
          xcodebuild \
            -workspace AlarmMessenger.xcworkspace \
            -scheme AlarmMessenger \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            build | xcbeautify || true
      
      # Release build only for tags - requires proper code signing
      - name: Build iOS Archive (Release)
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        working-directory: mobile/ios
        run: |
          # This requires proper Apple Developer setup with certificates
          # and provisioning profiles stored in GitHub Secrets
          # For now, we skip the actual build
          echo "iOS Release build requires Apple Developer Account and Code Signing"
          echo "To enable: Set up Fastlane Match or configure code signing certificates"
          echo "See: https://docs.github.com/en/actions/deployment/deploying-xcode-applications/installing-an-apple-certificate-on-macos-runners-for-xcode-development"
      
      - name: Build Info
        run: |
          echo "✅ Android APK built successfully"
          echo "ℹ️  iOS requires macOS and can only create debug builds without proper code signing"
          echo ""
          echo "To enable iOS release builds:"
          echo "1. Set up Apple Developer Account"
          echo "2. Configure code signing certificates in GitHub Secrets"
          echo "3. Update this workflow with proper signing configuration"
          echo ""
          echo "See docs/MOBILE.md for detailed iOS setup instructions"

  notify:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [android, ios]
    if: always()
    permissions:
      contents: read  # Minimal permissions for summary
    
    steps:
      - name: Summary
        run: |
          echo "## Mobile App Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Android: ${{ needs.android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: ${{ needs.ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: ✅ Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" == refs/tags/mobile-v* ]]; then
            echo "- Release APK: ✅ Available in workflow artifacts and GitHub Release" >> $GITHUB_STEP_SUMMARY
            echo "- Release AAB: ✅ Available in workflow artifacts and GitHub Release" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "Download build artifacts from the 'Artifacts' section above." >> $GITHUB_STEP_SUMMARY
