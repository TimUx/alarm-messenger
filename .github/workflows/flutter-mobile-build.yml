name: Flutter Mobile Build

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'mobile/**'
      - '.github/workflows/flutter-mobile-build.yml'
  pull_request:
    paths:
      - 'mobile/**'
      - '.github/workflows/flutter-mobile-build.yml'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  android:
    name: Build Android APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true
      
      - name: Flutter Doctor
        working-directory: mobile
        run: flutter doctor -v
      
      - name: Get dependencies
        working-directory: mobile
        run: flutter pub get
      
      - name: Analyze code
        working-directory: mobile
        run: flutter analyze
      
      - name: Run tests
        working-directory: mobile
        run: |
          if [ -d "test" ]; then
            echo "Running tests..."
            flutter test
          else
            echo "No test directory found. Skipping tests."
          fi
      
      - name: Build Android Debug APK
        working-directory: mobile
        run: flutter build apk --debug
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: mobile/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30
      
      # Release build only for tags or workflow_dispatch
      - name: Decode Keystore (Release)
        if: startsWith(github.ref, 'refs/tags/mobile-v') || github.event_name == 'workflow_dispatch'
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > mobile/android/app/alarm-messenger.keystore
            echo "Keystore decoded successfully"
          else
            echo "Warning: ANDROID_KEYSTORE_BASE64 secret not set. Skipping release build."
            exit 0
          fi
      
      - name: Build Android Release APK
        if: startsWith(github.ref, 'refs/tags/mobile-v') || github.event_name == 'workflow_dispatch'
        working-directory: mobile
        env:
          MYAPP_RELEASE_STORE_FILE: alarm-messenger.keystore
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -f android/app/alarm-messenger.keystore ]; then
            flutter build apk --release
          else
            echo "Keystore not found. Skipping release build."
          fi
      
      - name: Upload Release APK
        if: startsWith(github.ref, 'refs/tags/mobile-v') || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: mobile/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90
      
      - name: Build Android App Bundle (AAB)
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        working-directory: mobile
        env:
          MYAPP_RELEASE_STORE_FILE: alarm-messenger.keystore
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -f android/app/alarm-messenger.keystore ]; then
            flutter build appbundle --release
          fi
      
      - name: Upload Release AAB
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        uses: actions/upload-artifact@v4
        with:
          name: app-release-bundle
          path: mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 90
      
      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/mobile-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mobile/build/app/outputs/flutter-apk/app-release.apk
            mobile/build/app/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios:
    name: Build iOS IPA
    runs-on: macos-14
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true
      
      - name: Flutter Doctor
        working-directory: mobile
        run: flutter doctor -v
      
      - name: Get dependencies
        working-directory: mobile
        run: flutter pub get
      
      - name: Check and regenerate iOS platform
        working-directory: mobile
        run: |
          if [ ! -d "ios/Runner.xcodeproj" ]; then
            echo "⚠️  iOS project files are missing. Regenerating iOS platform..."
            flutter create --org com.alarmmessenger --platforms=ios .
            echo "✅ iOS platform files regenerated"
          else
            echo "✅ iOS project files found"
          fi
      
      - name: Build iOS (no codesign)
        working-directory: mobile
        run: |
          flutter build ios --release --no-codesign
      
      - name: Build Info
        run: |
          echo "✅ Android APK built successfully"
          echo "✅ iOS built successfully (no codesign)"
          echo ""
          echo "ℹ️  iOS requires macOS and proper code signing for distribution"
          echo ""
          echo "To enable iOS release builds:"
          echo "1. Set up Apple Developer Account"
          echo "2. Configure code signing certificates in GitHub Secrets"
          echo "3. Update this workflow with proper signing configuration"
          echo ""
          echo "See Flutter documentation for iOS deployment"

  notify:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [android, ios]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Summary
        run: |
          echo "## Flutter Mobile Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Android: ${{ needs.android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: ${{ needs.ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: ✅ Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" == refs/tags/mobile-v* ]]; then
            echo "- Release APK: ✅ Available in workflow artifacts and GitHub Release" >> $GITHUB_STEP_SUMMARY
            echo "- Release AAB: ✅ Available in workflow artifacts and GitHub Release" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "Download build artifacts from the 'Artifacts' section above." >> $GITHUB_STEP_SUMMARY
